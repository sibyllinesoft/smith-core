#!/bin/sh
set -e
BIN_NAME="$(basename "$0")"

# Resolve symlinks â€” npm global install symlinks $PREFIX/bin/<name> to the
# package, so $0 may be a symlink whose dirname is $PREFIX/bin/ rather than
# the actual script directory inside the package.
SOURCE="$0"
while [ -L "$SOURCE" ]; do
  DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  case "$SOURCE" in /*) ;; *) SOURCE="$DIR/$SOURCE" ;; esac
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
PKG_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

for pkg in smith-services-linux-x64 smith-services-darwin-arm64; do
  # Hoisted: sibling package under @sibyllinesoft/
  bin="$SCRIPT_DIR/../../$pkg/bin/$BIN_NAME"
  [ -x "$bin" ] && exec "$bin" "$@"
  # Nested: inside this package's own node_modules
  bin="$PKG_DIR/node_modules/@sibyllinesoft/$pkg/bin/$BIN_NAME"
  [ -x "$bin" ] && exec "$bin" "$@"
done
echo "Error: No pre-built $BIN_NAME binary found for this platform." >&2
echo "Supported: linux-x64, darwin-arm64" >&2
exit 1
